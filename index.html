<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Zizak ‚Ä¢ Setas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .card-chance-Alta { background-image: linear-gradient(to right, #D1FAE5, #34D399); }
    .card-chance-Media { background-image: linear-gradient(to right, #FEF3C7, #F59E0B); }
    .card-chance-Baja { background-image: linear-gradient(to right, #FEE2E2, #F87171); }
    .loading-spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #4CAF50; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .score-breakdown-details { animation: fadeIn 0.25s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    .score-breakdown li { margin-left: 1.5rem; position: relative; }
    .score-breakdown li::before { content: '‚úÖ'; position: absolute; left: -1.5rem; }
    .score-breakdown.no-score li::before { content: '‚ùå'; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.4); padding-top: 60px; }
    .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 1rem; position: relative; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    .chip { display: inline-flex; align-items: center; gap: .4rem; padding: .15rem .5rem; border-radius: 9999px; font-weight: 600; font-size: .75rem; }
    /* Bot√≥n idioma fijo arriba izda */
    #__langToggle{position:fixed;left:12px;top:12px;z-index:9999}
    #__langToggle button{background:#065f46;color:#fff;border-radius:9999px;padding:.35rem .6rem;font-weight:700;font-size:.85rem;box-shadow:0 4px 12px rgba(0,0,0,.14)}
    #__langToggle button:hover{background:#047857}
  </style>
</head>
<body class="bg-green-50 min-h-screen p-6 font-sans">
  <!-- Bot√≥n idioma -->
  <div id="__langToggle"><button id="__langBtn" type="button">Euskara</button></div>

  <header class="text-center mb-8 relative">
    <h1 class="text-4xl font-extrabold text-green-800 mb-2">üçÑ Zizak ‚Ä¢ Setas üå≤</h1>
    <p id="subtitle" class="text-lg text-gray-600" data-i18n="subtitle">Probabilidad general y especies m√°s probables seg√∫n condiciones.</p>
    <button id="help-button" class="absolute top-2 right-2 text-gray-400 hover:text-green-600 text-3xl font-bold leading-none" aria-label="Ayuda">&#9432;</button>
  </header>

  <div id="notification" class="max-w-6xl mx-auto mb-4 hidden p-4 rounded-md text-sm"></div>

  <div class="max-w-6xl mx-auto mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- A√±adir nueva ubicaci√≥n -->
    <div class="bg-white shadow-lg rounded-xl p-5 md:col-span-1">
      <h3 class="text-xl font-bold text-gray-800 mb-4" data-i18n="add.title">A√±adir nueva ubicaci√≥n</h3>
      <div id="add-location-form" class="space-y-4 flex-col">
        <div class="flex-1 flex gap-2">
          <input type="text" id="location-name" data-i18n-ph="add.placeholder" placeholder="Escribe el lugar (ej. Aralar, Navarra)" required class="w-full p-2 border border-gray-300 rounded-md" />
          <button type="button" id="search-button" class="bg-green-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-green-700 transition duration-300 ease-in-out" data-i18n="add.search">Buscar</button>
        </div>
        <details class="bg-green-50 rounded-md p-3 border border-green-200">
          <summary class="font-semibold text-green-800" data-i18n="add.habitatSummary">Opciones de h√°bitat (opcional)</summary>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
            <label class="block">
              <span class="text-gray-700" data-i18n="add.habitatType">Tipo de h√°bitat</span>
              <select id="habitat-select" class="mt-1 block w-full border rounded-md p-2"></select>
            </label>
            <label class="block">
              <span class="text-gray-700" data-i18n="add.age">Edad del arbolado</span>
              <select id="age-select" class="mt-1 block w-full border rounded-md p-2"></select>
            </label>
            <label class="block">
              <span class="text-gray-700" data-i18n="add.soil">Suelo</span>
              <select id="soil-select" class="mt-1 block w-full border rounded-md p-2"></select>
            </label>
          </div>
        </details>
        <div id="search-results" class="mt-2 hidden">
          <p id="search-status" class="text-sm text-gray-500 mb-2"></p>
          <button type="button" id="add-location-btn" class="bg-blue-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-300 ease-in-out hidden" data-i18n="add.addBtn">A√±adir a Mis Lugares</button>
        </div>
      </div>
    </div>

    <!-- Fase Lunar -->
    <div id="moon-phase-card" class="bg-white shadow-lg rounded-xl p-5 md:col-span-1 flex flex-col justify-center items-center">
      <h3 class="text-xl font-bold text-gray-800 mb-2 text-center" data-i18n="moon.title">Fase lunar</h3>
      <div class="flex items-center space-x-2">
        <span id="moon-emoji" class="text-4xl"></span>
        <div class="text-gray-700">
          <p id="moon-phase-name" class="font-semibold text-lg"></p>
          <p id="next-full-moon" class="text-xs"></p>
        </div>
      </div>
    </div>

    <!-- Parques -->
    <div class="bg-white shadow-lg rounded-xl p-5 md:col-span-1" id="parks-card">
      <h3 class="text-xl font-bold text-gray-800 mb-2" data-i18n="parks.title">Parques Micol√≥gicos</h3>
      <p class="text-sm text-gray-600 mb-3" id="parks-desc" data-i18n="parks.desc">Consulta la web de:</p>
      <div class="flex flex-wrap gap-2 justify-start">
        <a href="https://parquemicologicoultzama.com/" target="_blank" class="px-4 py-2 bg-green-200 text-green-800 rounded-md font-semibold hover:bg-green-300 transition-colors duration-200 text-sm">Ultzama</a>
        <a href="https://www.parquemicologicoerro.com/" target="_blank" class="px-4 py-2 bg-green-200 text-green-800 rounded-md font-semibold hover:bg-green-300 transition-colors duration-200 text-sm">Erro-Arribe</a>
      </div>
    </div>
  </div>

  <!-- Controles -->
  <div id="controls" class="bg-white shadow-lg rounded-xl p-4 mb-8 max-w-6xl mx-auto flex flex-wrap gap-4 items-center justify-between">
    <div class="flex flex-wrap gap-2 items-center">
      <span class="font-semibold text-gray-700" data-i18n="controls.filterBy">Filtrar por:</span>
      <button data-filter="all" class="filter-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md text-sm transition-colors duration-200" data-i18n="controls.all">Todas</button>
      <button data-filter="Alta" class="filter-btn bg-green-200 hover:bg-green-300 text-green-800 px-3 py-1 rounded-md text-sm transition-colors duration-200" data-i18n="controls.high">Alta</button>
      <button data-filter="Media" class="filter-btn bg-yellow-200 hover:bg-yellow-300 text-yellow-800 px-3 py-1 rounded-md text-sm transition-colors duration-200" data-i18n="controls.mid">Media</button>
      <button data-filter="Baja" class="filter-btn bg-red-200 hover:bg-red-300 text-red-800 px-3 py-1 rounded-md text-sm transition-colors duration-200" data-i18n="controls.low">Baja</button>
    </div>
    <div class="flex flex-wrap gap-2 items-center">
      <span class="font-semibold text-gray-700" data-i18n="controls.sortBy">Ordenar por:</span>
      <button data-sort="name" class="sort-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md text-sm transition-colors duration-200" data-i18n="controls.name">Nombre</button>
      <button data-sort="chance" class="sort-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md text-sm transition-colors duration-200" data-i18n="controls.chance">Probabilidad</button>
    </div>
  </div>

  <!-- Grid -->
  <div id="grid-container" class="max-w-6xl mx-auto">
    <p id="loading-message" class="text-center text-gray-700 text-lg hidden" data-i18n="loading">Cargando predicciones... <span class="loading-spinner inline-block align-middle ml-2"></span></p>
    <div id="grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <div id="welcome-message" class="hidden text-center max-w-2xl mx-auto p-8 bg-white shadow-lg rounded-xl">
      <h2 class="text-2xl font-bold text-green-700 mb-4" data-i18n="welcome.title">¬°Bienvenido/a!</h2>
      <p class="text-gray-600" data-i18n="welcome.text">Empieza a planificar tu pr√≥xima salida al monte a√±adiendo tus lugares favoritos con el buscador de arriba. Las ubicaciones que a√±adas se guardar√°n autom√°ticamente en tu navegador.</p>
    </div>
  </div>

  <!-- Modal de ayuda -->
  <div id="help-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="modal-content">
      <span class="close" aria-label="Cerrar">&times;</span>
      <h2 id="help-title" class="text-2xl font-bold text-green-800 mb-4" data-i18n="help.title">Acerca de esta aplicaci√≥n</h2>
      <p class="mb-4 text-gray-700" data-i18n="help.p1">Esta aplicaci√≥n estima la probabilidad de encontrar setas combinando condiciones meteorol√≥gicas recientes y un modelo heur√≠stico ajustado a h√°bitats t√≠picos del norte de Navarra.</p>
      <h3 class="font-bold text-lg mb-2" data-i18n="help.how">¬øC√≥mo se calcula la probabilidad?</h3>
      <ul class="list-disc list-inside space-y-2 mb-4 text-sm text-gray-700" id="help-list"></ul>
      <h3 class="font-bold text-lg mb-2" data-i18n="help.speciesMode">Modo especie</h3>
      <ul class="list-disc list-inside space-y-2 mb-4 text-sm text-gray-700" id="help-species"></ul>
      <p class="mt-6 text-xs text-gray-500 italic" data-i18n="help.footer">Recolecta con respeto y jam√°s consumas sin identificaci√≥n total. Esta herramienta es orientativa. Autor√≠a: Amilibia + Experto en Micolog√≠a.</p>
    </div>
  </div>

<script>
  // ===== Idiomas
  const I18N = {
    es: {
      subtitle: "Probabilidad general y especies m√°s probables seg√∫n condiciones.",
      add: {
        title: "A√±adir nueva ubicaci√≥n",
        placeholder: "Escribe el lugar (ej. Aralar, Navarra)",
        search: "Buscar",
        habitatSummary: "Opciones de h√°bitat (opcional)",
        habitatType: "Tipo de h√°bitat",
        age: "Edad del arbolado",
        soil: "Suelo",
        addBtn: "A√±adir a Mis Lugares",
        resultsProvince: "Provincia",
        resultsMunicipality: "Municipio",
        resultsCountry: "Pa√≠s",
        resultsCoords: "Coordenadas"
      },
      moon: { title: "Fase lunar", next: "Pr√≥xima luna llena: " },
      parks: { title: "Parques Micol√≥gicos", desc: "Consulta la web de:" },
      controls: { filterBy: "Filtrar por:", all: "Todas", high: "Alta", mid: "Media", low: "Baja", sortBy: "Ordenar por:", name: "Nombre", chance: "Probabilidad" },
      loading: "Cargando predicciones... ",
      welcome: { title: "¬°Bienvenido/a!", text: "Empieza a planificar tu pr√≥xima salida al monte a√±adiendo tus lugares favoritos con el buscador de arriba. Las ubicaciones que a√±adas se guardar√°n autom√°ticamente en tu navegador." },
      forecast7: "Previsi√≥n para 7 d√≠as:",
      speciesTitle: "Predicci√≥n por especie",
      temp: "Temp. (¬∞C)", rain: "Lluvia (mm)", et: "ET (mm)",
      score: "Puntuaci√≥n",
      chanceMap: { Alta: "Alta", Media: "Media", Baja: "Baja" },
      notif: {
        cached: "Usando datos meteorol√≥gicos cacheados.",
        offlineCached: "Sin conexi√≥n, usando datos cacheados.",
        noOffline: "Sin conexi√≥n a internet y sin datos cacheados.",
        errNew: "Error al obtener datos nuevos, usando datos cacheados.",
        errWeather: "Error al obtener datos meteorol√≥gicos.",
        errLoc: (n)=>`Error al cargar datos para ${n}.`,
        dup: "Esta ubicaci√≥n ya est√° en su lista.",
        pleaseName: "Por favor, introduce un nombre de ubicaci√≥n.",
        outBbox: "La ubicaci√≥n est√° fuera de Navarra o sus alrededores. Intente con otra.",
        notFound: "Ubicaci√≥n no encontrada. Intente ser m√°s espec√≠fico.",
        errSearch: "Error al buscar la ubicaci√≥n."
      },
      help: {
        title: "Acerca de esta aplicaci√≥n",
        p1: "Esta aplicaci√≥n estima la probabilidad de encontrar setas combinando condiciones meteorol√≥gicas recientes y un modelo heur√≠stico ajustado a h√°bitats t√≠picos del norte de Navarra.",
        how: "¬øC√≥mo se calcula la probabilidad?",
        list: [
          "Humedad de suelo (SMI) dependiente del tipo de suelo.",
          "Disparadores post‚Äëlluvia (umbra les por especie/h√°bitat).",
          "Temperatura efectiva (media 3 d√≠as y correcci√≥n por altitud).",
          "VPD (d√©ficit de presi√≥n de vapor) en lugar de solo humedad relativa.",
          "Penalizan: calor sostenido, viento con calor e heladas recientes.",
          "Estacionalidad por quincenas y ajuste suave por h√°bitat/edad/suelo."
        ],
        speciesMode: "Modo especie",
        speciesList: [
          "Boletus, Cantharellus, N√≠scalos, Lepista nuda y Hydnum repandum con pesos espec√≠ficos.",
          "Gr√°fico: barras apiladas por especie + l√≠nea de probabilidad base.",
          "La especie m√°s favorecida por d√≠a se marca como chip."
        ],
        footer: "Recolecta con respeto y jam√°s consumas sin identificaci√≥n total. Esta herramienta es orientativa. Autor√≠a: Amilibia + Experto en Micolog√≠a."
      }
    },
    eu: {
      subtitle: "Baldintzen arabera aukera orokorra eta ustezko espezieak.",
      add: {
        title: "Kokapen berria gehitu",
        placeholder: "Idatzi lekua (adib. Aralar, Nafarroa)",
        search: "Bilatu",
        habitatSummary: "Habitat aukerak (aukerakoa)",
        habitatType: "Habitat mota",
        age: "Basogintzaren adina",
        soil: "Lurra",
        addBtn: "Gehitu Nire Lekuetara",
        resultsProvince: "Probintzia",
        resultsMunicipality: "Udala",
        resultsCountry: "Herrialdea",
        resultsCoords: "Koordenadak"
      },
      moon: { title: "Ilargiaren fasea", next: "Hurrengo ilargi betea: " },
      parks: { title: "Parke Mikologikoak", desc: "Webgunea kontsultatu:" },
      controls: { filterBy: "Iragazi honen arabera:", all: "Guztiak", high: "Handia", mid: "Ertaina", low: "Txikia", sortBy: "Ordenatu honen arabera:", name: "Izena", chance: "Aukera" },
      loading: "Aurreikuspenak kargatzen... ",
      welcome: { title: "Ongi etorri!", text: "Hasi mendira irteera planifikatzen goiko bilatzailea erabiliz zure leku gogokoenak gehituz. Gehituriko kokapenak zure nabigatzailean gordeko dira." },
      forecast7: "7 egunetarako aurreikuspena:",
      speciesTitle: "Espezieen iragarpena",
      temp: "Tenp. (¬∞C)", rain: "Euria (mm)", et: "ET (mm)",
      score: "Puntuazioa",
      chanceMap: { Alta: "Handia", Media: "Ertaina", Baja: "Txikia" },
      notif: {
        cached: "Cacheatutako datu meteorologikoak erabiltzen.",
        offlineCached: "Konexiorik gabe, cachea erabiltzen.",
        noOffline: "Ez dago interneterik eta ez dago cache daturik.",
        errNew: "Datu berriak lortzean errorea, cachea erabiltzen.",
        errWeather: "Datu meteorologikoak jasotzean errorea.",
        errLoc: (n)=>`${n} kokapenaren datuak kargatzean errorea.`,
        dup: "Kokapen hau dagoeneko zerrendan dago.",
        pleaseName: "Mesedez, sartu kokapenaren izena.",
        outBbox: "Kokapena Nafarroatik edo inguruetatik kanpo dago. Saiatu beste batekin.",
        notFound: "Ez da kokapena aurkitu. Zehaztuago saiatu.",
        errSearch: "Kokapena bilatzean errorea."
      },
      help: {
        title: "Aplikazio honi buruz",
        p1: "Aplikazio honek onddoak aurkitzeko probabilitatea estimatzen du, azken eguraldi baldintzak eta Nafarroa iparraldeko habitatetara doitutako eredu heuristiko bat konbinatuta.",
        how: "Nola kalkulatzen da probabilitatea?",
        list: [
          "Lurzoru hezetasuna (SMI) lur motaren arabera.",
          "Euri ondoko abiarazleak (espezie/habitat araberako atalaseak).",
          "Tenperatura eraginkorra (3 eguneko batezbestekoa eta altitude‚Äëdoikuntza).",
          "VPD (lurrun‚Äëpresioaren defizita) HR soilik baino hobe.",
          "Kalte: bero jarraitua, haizea + beroa eta azken izozteak.",
          "Hamabostaldika estazionaltasuna eta habitat/adina/lur doikuntza leunak."
        ],
        speciesMode: "Espezie modua",
        speciesList: [
          "Boletus, Cantharellus, NisKalOak (Lactarius), Lepista nuda eta Hydnum repandum pisu espezifikoekin.",
          "Grafikoa: espeziez apilatutako barrak + oinarri‚Äëprob. lerroa.",
          "Eguneko espezie onena chip gisa markatzen da."
        ],
        footer: "Bildu errespetuz eta inoiz ez kontsumitu identifikazio osoa gabe. Tresna hau orientagarria da. Egiletza: Amilibia + Mikologiako aditua."
      }
    }
  };

  const getLang = ()=> localStorage.getItem('app_lang')||'es';
  const setLang = (v)=>{ const val=(v==='eu')?'eu':'es'; localStorage.setItem('app_lang',val); document.documentElement.setAttribute('data-lang',val); return val; };
  const isEU = ()=> getLang()==='eu';

  function t(path){ const lang = getLang(); const parts = path.split('.'); let node = I18N[lang]; for(const p of parts){ node = node?.[p]; if(node===undefined) return path; } return (typeof node==='function')? node() : node; }

  function applyStaticI18N(){
    const lang = getLang();
    document.querySelectorAll('[data-i18n]').forEach(el=>{ const key = el.getAttribute('data-i18n'); const v = t(key); if (v!=null) el.textContent = v; });
    document.querySelectorAll('[data-i18n-ph]').forEach(el=>{ const key = el.getAttribute('data-i18n-ph'); const v = t(key); if (v!=null) el.setAttribute('placeholder', v); });
    const b = document.getElementById('__langBtn'); if (b) b.textContent = (lang==='eu') ? 'Castellano' : 'Euskara';
  }

  // ===== Abreviaturas propias (evitamos toLocaleDateString)
  const WEEKDAY_SHORT = { es: ['dom','lun','mar','mi√©','jue','vie','s√°b'], eu: ['ig.','al.','ar.','az.','og.','ol.','lr.'] };
  const MONTH_SHORT   = { es: ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'], eu: ['urt','ots','mar','api','mai','eka','uzt','abu','ira','urr','aza','abe'] };
  const MONTH_LONG    = { es: ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'], eu: ['urtarrila','otsaila','martxoa','apirila','maiatza','ekaina','uztaila','abuztua','iraila','urria','azaroa','abendua'] };
  function fmtWeekdayDayMonthShort(dateLike, lang){ const d=(dateLike instanceof Date)?dateLike:new Date(dateLike); return `${WEEKDAY_SHORT[lang][d.getDay()]} ${d.getDate()} ${MONTH_SHORT[lang][d.getMonth()]}`; }
  function fmtDayMonthShort(dateLike, lang){ const d=(dateLike instanceof Date)?dateLike:new Date(dateLike); return `${d.getDate()} ${MONTH_SHORT[lang][d.getMonth()]}`; }
  function fmtDayMonthLong(dateLike, lang){ const d=(dateLike instanceof Date)?dateLike:new Date(dateLike); return (lang==='eu')? `${MONTH_LONG.eu[d.getMonth()]}ren ${d.getDate()}a` : `${d.getDate()} de ${MONTH_LONG.es[d.getMonth()]}`; }

  // ===== Opciones selects (valor estable; etiqueta traducida)
  const HABITATS = [ ['', '(sin especificar)'], ['hayedo','Hayedo'], ['robledal_atlantico','Robledal atl√°ntico'], ['pinar_silvestre','Pinar de pino silvestre'], ['carrascal','Carrascal'], ['mixto_caducifolio','Mixto caducifolio'] ];
  const HABITATS_EU = [ ['', '(zehaztu gabe)'], ['hayedo','Pago‚Äëbasoa'], ['robledal_atlantico','Harizti atlantikoa'], ['pinar_silvestre','Pinu gorria (pinar)'], ['carrascal','Arte‚Äësasia'], ['mixto_caducifolio','Hostoerorkor nahasia'] ];
  const AGES = [ ['', '(sin especificar)'], ['maduro','Maduro (>80)'], ['medio','Medio (40‚Äì80)'], ['joven','Joven (<40)'] ];
  const AGES_EU = [ ['', '(zehaztu gabe)'], ['maduro','Zaharra (>80)'], ['medio','Ertaina (40‚Äì80)'], ['joven','Gaztea (<40)'] ];
  const SOILS = [ ['', '(sin especificar)'], ['acidofilo','√Åcido'], ['basofilo','B√°sico'] ];
  const SOILS_EU = [ ['', '(zehaztu gabe)'], ['acidofilo','Azidoa'], ['basofilo','Oinarrizkoa'] ];

  function fillSelectOptions(){
    const lang = getLang();
    const fill = (sel, arr)=>{ if (!sel) return; const keep = sel.value; sel.innerHTML = arr.map(([v,l])=>`<option value="${v}">${l}</option>`).join(''); if (arr.some(([v])=>v===keep)) sel.value = keep; else sel.selectedIndex = 0; };
    fill(document.getElementById('habitat-select'), lang==='eu'?HABITATS_EU:HABITATS);
    fill(document.getElementById('age-select'), lang==='eu'?AGES_EU:AGES);
    fill(document.getElementById('soil-select'), lang==='eu'?SOILS_EU:SOILS);
  }

  // ===== Notificaciones
  function showNotification(message, type = 'info') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `max-w-6xl mx-auto mb-4 p-4 rounded-md text-sm ${type === 'error' ? 'bg-red-100 text-red-800' : type === 'warning' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}`;
    notification.classList.remove('hidden');
    setTimeout(() => notification.classList.add('hidden'), 3500);
  }

  // ===== APIs
  const OPENMETEO_API_URL = "https://api.open-meteo.com/v1/forecast";
  const NOMINATIM_API_URL = "https://nominatim.openstreetmap.org/search";

  // Altitud (Open‚ÄëMeteo elevation, sin CORS)
  async function fetchAltitude(lat, lon, { timeout=2500 } = {}) {
    const key = `alt:${lat.toFixed(5)},${lon.toFixed(5)}`;
    const c = localStorage.getItem(key);
    if (c !== null) return Number(c);
    try {
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeout);
      const r = await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lon}`, { signal: ctrl.signal, cache: 'no-store' });
      clearTimeout(t);
      const j = await r.json();
      const h = j?.elevation?.[0];
      if (Number.isFinite(h)) { localStorage.setItem(key, String(h)); return h; }
    } catch(_) {}
    return null;
  }

  // ===== Defaults Navarra
  const NAVARRA_BBOX = { minLon: -2.5, maxLon: -0.7, minLat: 41.8, maxLat: 43.4 };
  const DEFAULT_LOCATIONS = [
    { name: "Ultzama",     lat: 43.00952, lon: -1.68460, habitat: "hayedo", ageClass: "maduro", soilAcidity: "acidofilo" },
    { name: "Selva Irati", lat: 42.97500, lon: -1.11800, habitat: "hayedo", ageClass: "maduro", soilAcidity: "acidofilo" },
    { name: "Altsasu",     lat: 42.90780, lon: -2.17060, habitat: "hayedo", ageClass: "maduro", soilAcidity: "acidofilo" }
  ];

  let LOCATIONS = [];
  let currentFilter = 'all';
  let currentSort = 'name';
  let allForecastData = [];

  // ===== Tiempo / utilidades
  const WEATHER_ICONS = { 0:'‚òÄÔ∏è',1:'üå§Ô∏è',2:'‚õÖ',3:'‚òÅÔ∏è',45:'üå´Ô∏è',48:'üå´Ô∏è',51:'üåßÔ∏è',53:'üåßÔ∏è',55:'üåßÔ∏è',56:'üåßÔ∏è',57:'üåßÔ∏è',61:'üå¶Ô∏è',63:'üåßÔ∏è',65:'‚õàÔ∏è',66:'üå®Ô∏è',67:'üå®Ô∏è',71:'üå®Ô∏è',73:'üå®Ô∏è',75:'üå®Ô∏è',77:'üå®Ô∏è',80:'üåßÔ∏è',81:'üåßÔ∏è',82:'‚õàÔ∏è',85:'üå®Ô∏è',86:'üå®Ô∏è',95:'üå©Ô∏è',96:'‚õàÔ∏è',99:'‚õàÔ∏è', default:'‚ùì' };
  const clamp=(x,lo,hi)=>Math.max(lo,Math.min(hi,x));
  function getWeatherIcon(code){ return WEATHER_ICONS[code]||WEATHER_ICONS.default; }
  function todayLocalYYYYMMDD(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
  function movingAvg(a,k=3){ const n=a.length, out=new Array(n).fill(0); for(let i=0;i<n;i++){ let s=0,c=0; for(let j=0;j<k;j++){ const idx=i-j; if(idx>=0){ s+=a[idx]; c++; } } out[i]=s/Math.max(1,c);} return out; }

  // VPD (kPa) from T (¬∞C) and RH (%)
  function vpdFromTempRH(T, RH){ const es=0.6108*Math.exp((17.27*T)/(T+237.3)); return es*(1 - (RH||0)/100); }

  async function fetchWeather(lat, lon, pastDays=14, forecastDays=7){
    const cacheKey = `weather_${lat}_${lon}_${pastDays}_${forecastDays}`;
    const cached = localStorage.getItem(cacheKey);
    const time = localStorage.getItem(`${cacheKey}_time`);
    const lang = getLang();
    if (cached && time && (Date.now()-parseInt(time)) < 6*3600*1000){ showNotification(I18N[lang].notif.cached, 'info'); return JSON.parse(cached); }
    if (!navigator.onLine){ if (cached){ showNotification(I18N[lang].notif.offlineCached,'warning'); return JSON.parse(cached); } showNotification(I18N[lang].notif.noOffline,'error'); throw new Error('Offline'); }
    const url = `${OPENMETEO_API_URL}?latitude=${lat}&longitude=${lon}&past_days=${pastDays}&forecast_days=${forecastDays}&hourly=temperature_2m,relative_humidity_2m,precipitation,dew_point_2m,weather_code,wind_speed_10m,et0_fao_evapotranspiration&timezone=Europe%2FMadrid`;
    try{ const r = await fetch(url); if(!r.ok) throw new Error(`HTTP ${r.status}`); const data = await r.json(); localStorage.setItem(cacheKey, JSON.stringify(data)); localStorage.setItem(`${cacheKey}_time`, Date.now().toString()); return data; }catch(e){ if (cached){ showNotification(I18N[lang].notif.errNew,'warning'); return JSON.parse(cached); } showNotification(I18N[lang].notif.errWeather,'error'); throw e; }
  }

  // ===== Agregaci√≥n diaria
  function processDailyData(data){
    const days = {};
    data.hourly.time.forEach((time, i)=>{
      const date = new Date(time).toISOString().split('T')[0];
      if(!days[date]) days[date] = { temps:[], rain_for_day:0, humidities:[], dew_points:[], weather_codes:[], wind_speeds:[], temp_max:-Infinity, et0:[] };
      days[date].temps.push(data.hourly.temperature_2m[i]);
      days[date].humidities.push(data.hourly.relative_humidity_2m[i]);
      days[date].dew_points.push(data.hourly.dew_point_2m[i]);
      days[date].rain_for_day += data.hourly.precipitation[i]||0;
      days[date].weather_codes.push(data.hourly.weather_code[i]);
      days[date].wind_speeds.push(data.hourly.wind_speed_10m[i]);
      days[date].et0.push(data.hourly.et0_fao_evapotranspiration[i]||0);
      if (data.hourly.temperature_2m[i] > days[date].temp_max) days[date].temp_max = data.hourly.temperature_2m[i];
    });
    return Object.entries(days).map(([date, v])=>({
      date,
      temps: v.temps,
      humidities: v.humidities,
      rain_for_day: v.rain_for_day,
      dew_points: v.dew_points,
      wind_speeds: v.wind_speeds,
      et0: v.et0,
      temp_min: Math.min(...v.temps),
      temp_max: v.temp_max,
      avg_temp: v.temps.reduce((a,b)=>a+b,0)/v.temps.length||0,
      avg_humidity: v.humidities.reduce((a,b)=>a+b,0)/v.humidities.length||0,
      avg_dew_point: v.dew_points.reduce((a,b)=>a+b,0)/v.dew_points.length||0,
      avg_wind_speed: v.wind_speeds.reduce((a,b)=>a+b,0)/v.wind_speeds.length||0,
      avg_et0: v.et0.reduce((a,b)=>a+b,0)/v.et0.length||0,
      weather_code: getDominantWeatherCode(v.weather_codes)
    }));
  }
  function getDominantWeatherCode(codes){ const counts=codes.reduce((a,c)=>(a[c]=(a[c]||0)+1,a),{}); return parseInt(Object.keys(counts).sort((a,b)=>counts[b]-counts[a])[0]); }

  // ===== Hidrolog√≠a y triggers (con Smax por suelo)
  function computeSoilMoistureIndex(rain, et0, Smax){ let S=Smax*0.5; const out=[]; for(let i=0;i<rain.length;i++){ const eff=Math.min(rain[i]||0,25)*0.8; const e=Math.max(et0[i]||0,0); S=clamp(S+eff-e,0,Smax); out.push(S/Smax);} return out; }
  function computePulseGaussian(rain, windowDays, threshold, lagMin, lagMax){ const n=rain.length, trig=new Array(n).fill(0); let last=-Infinity; for(let i=0;i<n;i++){ const sum=rain.slice(Math.max(0,i-windowDays+1), i+1).reduce((a,b)=>a+(b||0),0); if(sum>=threshold) last=i; const d=i-last; if(d>=lagMin&&d<=lagMax){ const mid=(lagMin+lagMax)/2, sigma=(lagMax-lagMin)/4; trig[i]=Math.exp(-0.5*Math.pow((d-mid)/sigma,2)); } } return trig; }

  // ===== Modelo base + mejoras solicitadas
  const HABITAT_MULTIPLIER={hayedo:1.15, robledal_atlantico:1.10, mixto_caducifolio:1.08, pinar_silvestre:1.00, carrascal:0.85};
  const AGE_MULTIPLIER={maduro:1.10, medio:1.00, joven:0.90};
  const SOIL_MULTIPLIER={acidofilo:1.10, basofilo:1.00};

  function doy(dateLike){ const d=(dateLike instanceof Date)?dateLike:new Date(dateLike); const start=new Date(d.getFullYear(),0,0); const diff=d-start; return Math.floor(diff/86400000); }
  function gauss(x,mu,s){ const z=(x-mu)/s; return Math.exp(-0.5*z*z); }

  function seasonFortnightWeight(d, species){
    const x=doy(d);
    switch(species){
      case 'boletus': return Math.max(0.2, Math.max(gauss(x, 285, 18), gauss(x, 250, 22))); // oct-primera quincena + sep tard√≠o
      case 'cantharellus': return Math.max(0.2, gauss(x, 240, 40)); // verano tard√≠o-amplio
      case 'lactarius': return Math.max(0.2, gauss(x, 300, 20)); // finales oct-nov
      case 'lepista_nuda': return Math.max(0.2, gauss(x, 320, 25)); // nov-mediados dic
      case 'hydnum_repandum': return Math.max(0.2, gauss(x, 295, 20)); // oct-nov
      default: return 1.0;
    }
  }

  function computeMushroomChances(dailyData, location){
    // Smax por tipo de suelo
    const Smax = location.soilAcidity==='acidofilo'?90 : (location.soilAcidity==='basofilo'?70 : 80);

    // Series de entrada
    const rain = dailyData.map(d=>d.rain_for_day||0);
    const et0  = dailyData.map(d=>d.avg_et0||0);
    const tmed = dailyData.map(d=>(d.temp_min+d.temp_max)/2);
    const rh   = dailyData.map(d=>d.avg_humidity||0);
    const wind = dailyData.map(d=>d.avg_wind_speed||0);

    // Correcci√≥n por altitud (lapse rate)
    const alt = Number.isFinite(location.altitude)? location.altitude : 600; // referencia 600 m
    const tCorr = tmed.map(T => T - 0.006*(alt - 600));
    const tCorr3 = movingAvg(tCorr,3);

    // SMI
    const smi = computeSoilMoistureIndex(rain, et0, Smax);

    // VPD medio diario (kPa) con T corregida y RH media
    const vpd = dailyData.map((d,i)=> vpdFromTempRH(tCorr[i], rh[i]));

    // Triggers por lluvia (diferentes umbrales)
    const trig15 = computePulseGaussian(rain, 2, 15, 4, 10);
    const trig20 = computePulseGaussian(rain, 2, 20, 5, 12);
    const trig25 = computePulseGaussian(rain, 2, 25, 6, 12);

    const results = dailyData.map((d,i)=>{
      let sc=0; const bd=[];
      // Suelo / SMI
      if (smi[i]>=0.7){ sc+=2.5; bd.push('Suelo h√∫medo (SMI ‚â• 0.7) (+2.5)'); }
      else if (smi[i]>=0.5){ sc+=1.5; bd.push('Suelo con humedad media (SMI ‚â• 0.5) (+1.5)'); }
      else if (smi[i]>0.3){ sc+=0.5; bd.push('Suelo algo seco (SMI > 0.3) (+0.5)'); }
      else { bd.push('Suelo seco (SMI ‚â§ 0.3)'); }

      // Post‚Äëlluvia general (d√©bil; lo fuerte se aplica por especie)
      if (trig20[i]>0){ const add=0.8*trig20[i]; sc+=add; bd.push(`Brote tras lluvia reciente (+${add.toFixed(1)})`); }

      // Temperatura efectiva general (ventana 8‚Äì18 ¬∞C con T_corr_3d)
      const optMin=8, optMax=18; const T=tCorr3[i];
      if(T>=optMin&&T<=optMax){ sc+=1.4; bd.push(`Temp. √≥ptima (${optMin}-${optMax}¬∞C) (+1.4)`); }
      else if(T>24){ sc-=1.0; bd.push('Calor alto (>24¬∞C) (‚àí1.0)'); }

      // VPD (mejor que solo HR)
      const v=vpd[i];
      if (v<=0.6){ sc+=1.0; bd.push(`VPD bajo (+1.0)`); }
      else if (v<=1.2){ sc+=0.5; bd.push(`VPD medio (+0.5)`); }
      else if (v>2.0){ sc-=0.8; bd.push('VPD alto (‚àí0.8)'); }

      // Viento+calor (media 3d)
      const avg3Wind = i>=2?(wind[i]+wind[i-1]+wind[i-2])/3:wind[i];
      const avg3Temp = i>=2?(tCorr[i]+tCorr[i-1]+tCorr[i-2])/3:tCorr[i];
      if(avg3Wind>20 && avg3Temp>20){ sc-=1.2; bd.push('Viento+calor (‚àí1.2)'); }

      // Heladas recientes
      const last7 = dailyData.slice(Math.max(0,i-6), i+1); const frost = last7.filter(d=>d.temp_min<=-2).length; if(frost>=2){ sc-=1.3; bd.push('Heladas recientes (‚àí1.3)'); }

      // Altitud (retraso temporada) ya considerada en T_corr; solo leve sesgo topogr√°fico
      if (alt>1000){ sc-=0.3; bd.push('Alta monta√±a (>1000 m, retraso temporada) (‚àí0.3)'); }
      if (alt<800 && new Date(dailyData[i].date).getMonth()<8){ sc-=0.8; bd.push('Zona baja y temporada temprana (‚àí0.8)'); }

      // Multiplicadores por h√°bitat/edad/suelo
      let mult=1.0; if(location.habitat) mult*=(HABITAT_MULTIPLIER[location.habitat]||1.0); if(location.ageClass) mult*=(AGE_MULTIPLIER[location.ageClass]||1.0); if(location.soilAcidity) mult*=(SOIL_MULTIPLIER[location.soilAcidity]||1.0); if(mult!==1.0) bd.push(`Factor de h√°bitat √ó${mult.toFixed(2)}`); sc*=mult;

      // Probabilidad base (log√≠stica)
      const prob = 1/(1+Math.exp(-(sc-5.0))); // umbral ligeramente menor por VPD
      const p=clamp(prob*100,0,100);

      return { ...d, smi:smi[i], vpd:v, tmed:T, baseProb:p, score:`${p.toFixed(1)}%`, chance: p>=75?'Alta':(p>=50?'Media':'Baja'), score_breakdown:bd };
    });

    return results;
  }

  // ===== Especies: pesos espec√≠ficos (optimos T, SMI, trigger por especie/h√°bitat)
  const SPECIES = {
    boletus:       { key:'boletus',       label:'Boletus gr. edulis',                 color:'#047857', light:'#D1FAE5', temp:[10,18], smi:[0.55,0.75] },
    cantharellus:  { key:'cantharellus',  label:'Cantharellus cibarius',             color:'#CA8A04', light:'#FEF3C7', temp:[8,20],  smi:[0.60,0.85] },
    lactarius:     { key:'lactarius',     label:'N√≠scalos (Lactarius gr. deliciosus)', color:'#B91C1C', light:'#FEE2E2', temp:[9,16],  smi:[0.50,0.70] },
    lepista_nuda:  { key:'lepista_nuda',  label:'Lepista nuda (pie azul)',           color:'#6D28D9', light:'#EDE9FE', temp:[4,12],  smi:[0.60,0.80] },
    hydnum_repandum:{key:'hydnum_repandum',label:'Hydnum repandum (lengua de vaca)', color:'#9A3412', light:'#FFEDD5', temp:[6,15],  smi:[0.60,0.80] }
  };

  function triangleSuitability(x,[min,max]){ if(x<=min||x>=max) return 0; const mid=(min+max)/2; return x<=mid ? (x-min)/(mid-min) : (max-x)/(max-mid); }
  function smiSuitability(s,[lo,hi]){ if(s<=lo) return s/lo*0.6; if(s>=hi) return 1; const r=(s-lo)/(hi-lo); return 0.6+0.4*r; }

  function speciesPulseWeight(i, speciesKey, habitat, smiVal, trig15, trig20, trig25){
    // Reglas: Boletus -> 20‚Äì25 mm; Cantharellus -> si SMI alto usar 15 mm; Lactarius -> sensible al pulso en pinar (15 mm, 4‚Äì10 d)
    if (speciesKey==='boletus') return Math.max(trig25[i], trig20[i]);
    if (speciesKey==='cantharellus') return (smiVal>=0.6? trig15[i] : trig20[i]);
    if (speciesKey==='lactarius') return (habitat==='pinar_silvestre' ? trig15[i] : Math.max(trig20[i],trig25[i]*0.7));
    return Math.max(trig15[i]*0.6, trig20[i]*0.6); // otras especies, efecto moderado
  }

  function computeSpeciesProbsForDay(day, i, location, ctx){
    const { tCorr3, smi, trig15, trig20, trig25 } = ctx;
    const habitat = location.habitat || '';
    const alt = Number.isFinite(location.altitude)? location.altitude : 600;
    const T = tCorr3[i];
    const monthIdx = new Date(day.date).getMonth(); // por si se quiere
    const raw={};
    Object.values(SPECIES).forEach(sp=>{
      const wTemp = Math.pow(triangleSuitability(T, sp.temp), 1.15); // algo m√°s de peso
      const wSmi  = Math.pow(smiSuitability(smi[i], sp.smi), 1.1);
      const wPulse = speciesPulseWeight(i, sp.key, habitat, smi[i], trig15, trig20, trig25);
      const wSeason = seasonFortnightWeight(day.date, sp.key);
      const wHab = habitat && sp.key==='lactarius' && habitat==='pinar_silvestre' ? 1.10 : 1.0; // peque√±o sesgo
      const rawScore = wTemp*wSmi*(0.5 + 0.5*wPulse)*wSeason*wHab; // 0.5‚Äì1 factor por pulso
      raw[sp.key] = rawScore;
    });
    const sumRaw = Object.values(raw).reduce((a,b)=>a+b,0)||1e-6;
    const speciesProbs={}; Object.keys(raw).forEach(k=>{ speciesProbs[k]=(raw[k]/sumRaw)*(day.baseProb); });
    const topKey = Object.keys(speciesProbs).sort((a,b)=>speciesProbs[b]-speciesProbs[a])[0];
    return { speciesProbs, topKey };
  }

  function annotateSpecies(location, ctx){ location.forecast = location.forecast.map((d,i)=>{ const {speciesProbs, topKey}=computeSpeciesProbsForDay(d,i, location, ctx); d.species=speciesProbs; d.top_species=topKey; return d; }); return location; }

  // ===== Pipeline de actualizaci√≥n
  async function updateLocationData(location){
    try{
      const weatherData = await fetchWeather(location.lat, location.lon, 14, 7);
      const altitude = await fetchAltitude(location.lat, location.lon);
      const dailyData = processDailyData(weatherData);

      location.altitude = altitude;

      // Pre‚Äëcalcular contextos para especies
      const rain = dailyData.map(d=>d.rain_for_day||0);
      const et0  = dailyData.map(d=>d.avg_et0||0);
      const tmed = dailyData.map(d=>(d.temp_min+d.temp_max)/2);
      const rh   = dailyData.map(d=>d.avg_humidity||0);
      const alt  = Number.isFinite(location.altitude)? location.altitude : 600;
      const tCorr = tmed.map(T => T - 0.006*(alt - 600));
      const tCorr3 = movingAvg(tCorr,3);
      const Smax = location.soilAcidity==='acidofilo'?90 : (location.soilAcidity==='basofilo'?70 : 80);
      const smi = computeSoilMoistureIndex(rain, et0, Smax);
      const trig15 = computePulseGaussian(rain, 2, 15, 4, 10);
      const trig20 = computePulseGaussian(rain, 2, 20, 5, 12);
      const trig25 = computePulseGaussian(rain, 2, 25, 6, 12);

      // Probabilidad base
      const forecastBase = computeMushroomChances(dailyData, location);
      const ctx = { tCorr3, smi, trig15, trig20, trig25 };
      location.forecast = forecastBase; // base con breakdown
      annotateSpecies(location, ctx);

      allForecastData.push(location);
      return location;
    }catch(error){ console.error('Error fetching data for', location.name, error); showNotification(I18N[getLang()].notif.errLoc(location.name),'error'); return null; }
  }

  // ===== Render tarjetas
  function slugify(s){ return String(s).toLowerCase().replace(/[^a-z0-9]+/g,'-'); }

  function renderLocationCard(location){
    const lang = getLang();
    const todayDateString = todayLocalYYYYMMDD();
    const todayIndex = location.forecast.findIndex(day => day.date === todayDateString);
    const effectiveTodayIndex = todayIndex !== -1 ? todayIndex : 0;

    const todayForecast = location.forecast[effectiveTodayIndex] || { chance: 'Baja', score: '0%', top_species: null };
    const cardChanceClass = `card-chance-${todayForecast.chance}`;
    const cid = `chart-${slugify(location.name)}`;
    const speciesCid = `species-${slugify(location.name)}`;

    const card = document.createElement('div');
    card.className = `bg-white shadow-xl rounded-xl overflow-hidden transform transition-all duration-300 hover:scale-105 card-item ${cardChanceClass}`;
    card.dataset.chance = todayForecast.chance;
    card.dataset.name = location.name;

    const headerRightBtnLabel = (lang==='eu'?'Kendu kokapena':'Eliminar ubicaci√≥n');

    card.innerHTML = `
      <div class="p-6 relative">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h4 class="text-2xl font-bold text-gray-800">${location.name}</h4>
            <div class="text-xs text-gray-600 mt-1">${Number(location.lat).toFixed(5)}, ${Number(location.lon).toFixed(5)}${Number.isFinite(location.altitude)?` ¬∑ ${Math.round(location.altitude)} m`:''}</div>
          </div>
          <div class="flex items-center space-x-2">
            <button class="remove-location-btn p-2 text-gray-400 hover:text-red-600 text-lg" aria-label="${headerRightBtnLabel}" data-location-name="${location.name}">
              <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
          </div>
        </div>

        <div class="w-full h-48 mb-4"><canvas id="${cid}"></canvas></div>

        <div class="mb-4">
          <h5 class="font-bold text-gray-800 mb-2" data-i18n="speciesTitle">${I18N[lang].speciesTitle}</h5>
          <div class="w-full h-40"><canvas id="${speciesCid}"></canvas></div>
        </div>

        <div class="full-forecast border-t border-gray-200 pt-4">
          <h5 class="font-bold text-gray-800 mb-2">${I18N[lang].forecast7}</h5>
          <ul class="space-y-2">
            ${
              location.forecast.slice(effectiveTodayIndex, effectiveTodayIndex + 7).map((day, index) => {
                const topK = day.top_species; const sp = topK ? SPECIES[topK] : null;
                const chip = sp ? `<span class=\"chip\" style=\"background:${sp.light}; color:${sp.color}\">‚óè ${sp.label}</span>` : '';
                const label = fmtWeekdayDayMonthShort(day.date, lang);
                const chanceText = I18N[lang].chanceMap[day.chance] || day.chance;
                const chanceClass = day.chance==='Alta'?'bg-green-600 text-white':(day.chance==='Media'?'bg-yellow-600 text-white':'bg-red-600 text-white');
                return `
                  <li class=\"flex flex-col text-sm text-gray-600 border-b border-gray-200 last:border-b-0 py-2\">
                    <div class=\"flex justify-between items-center\">
                      <div class=\"flex-1 flex flex-wrap items-center gap-2 pr-2\">
                        <span class=\"font-semibold\">${label}</span>
                        <span class=\"font-semibold text-gray-800\">${getWeatherIcon(day.weather_code)} ${day.temp_min.toFixed(0)}¬∞C - ${day.temp_max.toFixed(0)}¬∞C</span>
                        <span class=\"font-semibold text-gray-800\">${day.rain_for_day.toFixed(1)}mm</span>
                        ${chip}
                      </div>
                      <div class=\"flex items-center space-x-2\">
                        <span class=\"px-2 py-1 text-xs font-bold rounded-full ${chanceClass}\">${chanceText}</span>
                        <button class=\"toggle-score-btn text-gray-400 hover:text-green-600 text-lg\" data-target-id=\"score-details-${slugify(location.name)}-${index}\">&#9432;</button>
                      </div>
                    </div>
                    <div id=\"score-details-${slugify(location.name)}-${index}\" class=\"score-breakdown-details text-xs mt-2 w-full pl-4 hidden\">
                      <p class=\"font-bold text-gray-700\">${I18N[lang].score}: <span class=\"text-green-800\">${day.score}</span></p>
                      <ul class=\"score-breakdown text-xs text-gray-600 ${day.score_breakdown.length===0?'no-score':''}\">${day.score_breakdown.map(item=>`<li>${item}</li>`).join('')}</ul>
                    </div>
                  </li>`;
              }).join('')
            }
          </ul>
        </div>
      </div>
    `;

    document.getElementById('grid').appendChild(card);

    // ==== Gr√°fico HIST√ìRICO (√∫ltimos 7 previos)
    const historyData = location.forecast.slice(Math.max(0, effectiveTodayIndex - 7), effectiveTodayIndex);
    const dates = historyData.map(d => fmtDayMonthShort(d.date, lang));
    const temps = historyData.map(d => d.tmed || (d.temp_min + d.temp_max)/2);
    const rain = historyData.map(d => d.rain_for_day);
    const et0 = historyData.map(d => d.avg_et0 || 0);

    new Chart(document.getElementById(cid).getContext('2d'), {
      type: 'line',
      data: { labels: dates, datasets: [
        { label: I18N[lang].temp, data: temps, borderColor: '#ef4444', tension: .25 },
        { label: I18N[lang].rain, data: rain, borderColor: '#3b82f6', tension: .25, yAxisID: 'y1' },
        { label: I18N[lang].et,   data: et0,  borderColor: '#10b981', tension: .25, yAxisID: 'y2' }
      ]},
      options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:true}}, scales:{y1:{position:'right'}, y2:{position:'right'}} }
    });

    // ==== Gr√°fico ESPECIES pr√≥ximos 7 d√≠as
    const next7 = location.forecast.slice(effectiveTodayIndex, effectiveTodayIndex + 7);
    const dayLabels = next7.map(d => fmtWeekdayDayMonthShort(d.date, lang));
    const speciesKeys = Object.keys(SPECIES);
    const stackedDatasets = speciesKeys.map(k => ({ label: SPECIES[k].label, data: next7.map(d => (d.species?.[k]||0)), backgroundColor: SPECIES[k].color, stack:'sp' }));
    const baseLine = { type:'line', label:(isEU()?'Oinarri‚Äëprob.':'Probabilidad base'), data: next7.map(d=>d.baseProb), borderColor:'#9CA3AF', borderWidth:2, pointRadius:0, yAxisID:'y' };

    new Chart(document.getElementById(speciesCid).getContext('2d'), {
      type: 'bar',
      data: { labels: dayLabels, datasets: [...stackedDatasets, baseLine] },
      options: { responsive:true, maintainAspectRatio:false, scales:{ x:{stacked:true}, y:{stacked:true, max:100, ticks:{ callback:(v)=> v+'%' }} }, plugins:{ legend:{ display:false } } }
    });

    // eliminar ubicaci√≥n
    card.querySelector('.remove-location-btn').addEventListener('click', (e)=>{
      const name = e.currentTarget.dataset.locationName;
      LOCATIONS = LOCATIONS.filter(l => l.name !== name);
      allForecastData = allForecastData.filter(l => l.name !== name);
      saveLocations();
      refreshGrid();
    });
  }

  function refreshGrid(){
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    const todayDateString = todayLocalYYYYMMDD();
    const filtered = allForecastData.filter(loc => {
      const i = loc.forecast.findIndex(d => d.date === todayDateString);
      const ch = loc.forecast[i !== -1 ? i : 0]?.chance || 'Baja';
      return currentFilter === 'all' || ch === currentFilter;
    });
    if (filtered.length === 0 && allForecastData.length > 0) {
      grid.innerHTML = `<p class="text-center text-gray-500 col-span-full">${isEU()?'Ez dago filtroarekin bat datorren kokapenik.':'No hay ubicaciones que coincidan con el filtro.'}</p>`;
    } else if (allForecastData.length === 0) {
      document.getElementById('welcome-message').classList.remove('hidden');
    } else {
      document.getElementById('welcome-message').classList.add('hidden');
      filtered.sort((a,b)=>{
        const today = todayLocalYYYYMMDD();
        const aC = a.forecast.find(d=>d.date===today)?.chance || 'Baja';
        const bC = b.forecast.find(d=>d.date===today)?.chance || 'Baja';
        if (currentSort==='chance'){
          const order = { 'Alta':0, 'Media':1, 'Baja':2 };
          return (order[aC]-order[bC]) || a.name.localeCompare(b.name);
        }
        return a.name.localeCompare(b.name);
      }).forEach(renderLocationCard);
    }
  }

  function saveLocations(){ localStorage.setItem('mushroomLocations', JSON.stringify(LOCATIONS)); }

  async function loadLocations(){
    const saved = localStorage.getItem('mushroomLocations');
    LOCATIONS = saved ? JSON.parse(saved) : DEFAULT_LOCATIONS;
    document.getElementById('loading-message').classList.remove('hidden');
    const res = await Promise.all(LOCATIONS.map(loc => updateLocationData(loc)));
    allForecastData = res.filter(l=>l!==null);
    document.getElementById('loading-message').classList.add('hidden');
    refreshGrid();
  }

  // ===== Luna (biling√ºe y sin influir en el modelo)
  const MOON_PHASE_EMOJI = ['üåë','üåí','üåì','üåî','üåï','üåñ','üåó','üåò'];
  const MOON_PHASE_NAME = { es: ['Luna Nueva','Luna Creciente','Cuarto Creciente','Luna Gibosa Creciente','Luna Llena','Luna Gibosa Menguante','Cuarto Menguante','Luna Menguante'], eu: ['Ilargi berria','Ilgora','Laurden gorantz','Ilgora handitua','Ilargi betea','Ilbehera handitua','Laurden beherantz','Ilbehera'] };
  function getMoonPhaseFrac(date){ const jul=date.getTime()/86400000+2440587.5; const cycle=29.53058867; const new1970=2440409.5; const diff=jul-new1970; const phase=diff%cycle; return phase/cycle; }
  function getMoonIndex(date){ let idx=Math.floor(getMoonPhaseFrac(date)*8); return idx===8?0:idx; }
  function nextFullMoon(date){ for(let i=1;i<=40;i++){ const n=new Date(date); n.setDate(date.getDate()+i); if(getMoonIndex(n)===4) return n; } return null; }
  function renderMoonPhase(){ const lang=getLang(); const today=new Date(); const idx=getMoonIndex(today); const emoji=MOON_PHASE_EMOJI[idx]; const name=MOON_PHASE_NAME[lang][idx]; const nextFM = nextFullMoon(today); document.getElementById('moon-emoji').textContent=emoji; document.getElementById('moon-phase-name').textContent=name; document.getElementById('next-full-moon').textContent = (I18N[lang].moon.next) + (nextFM? fmtDayMonthLong(nextFM, lang) : '‚Äî'); }

  // ===== B√∫squeda Nominatim
  const searchButton = document.getElementById('search-button');
  const locationNameInput = document.getElementById('location-name');
  const searchResultsDiv = document.getElementById('search-results');
  const searchStatusP = document.getElementById('search-status');
  const addLocationBtn = document.getElementById('add-location-btn');
  const habitatSelect = document.getElementById('habitat-select');
  const ageSelect = document.getElementById('age-select');
  const soilSelect = document.getElementById('soil-select');
  let foundLocation = null;

  async function doSearch(){
    const lang=getLang();
    const query = locationNameInput.value.trim();
    if (query===''){ showNotification(I18N[lang].notif.pleaseName,'warning'); return; }
    searchStatusP.innerHTML = `${lang==='eu'?'Bilatzen':'Buscando'} <b>${query}</b>... <span class="loading-spinner inline-block align-middle ml-2"></span>`;
    searchResultsDiv.classList.remove('hidden');
    addLocationBtn.classList.add('hidden');
    addLocationBtn.textContent = I18N[lang].add.addBtn;
    try{
      const bbox = `${NAVARRA_BBOX.minLon},${NAVARRA_BBOX.minLat},${NAVARRA_BBOX.maxLon},${NAVARRA_BBOX.maxLat}`;
      const r = await fetch(`${NOMINATIM_API_URL}?q=${encodeURIComponent(query)}&format=json&limit=1&bounded=1&viewbox=${bbox}&addressdetails=1&namedetails=1`);
      const data = await r.json();
      if (data && data.length>0){
        const loc = data[0]; const lat=parseFloat(loc.lat), lon=parseFloat(loc.lon);
        if (lat>=NAVARRA_BBOX.minLat && lat<=NAVARRA_BBOX.maxLat && lon>=NAVARRA_BBOX.minLon && lon<=NAVARRA_BBOX.maxLon){
          const name = loc.namedetails?.["name:eu"] || loc.display_name.split(',')[0];
          const province = loc.address?.state || loc.address?.province || "";
          const municipality = loc.address?.town || loc.address?.city || loc.address?.village || "";
          const country = loc.address?.country || "";
          foundLocation = { name, lat, lon, province, municipality, country };
          searchStatusP.innerHTML = `
            <b>${name}</b><br>
            ${I18N[lang].add.resultsProvince}: ${province||"‚Äî"}<br>
            ${I18N[lang].add.resultsMunicipality}: ${municipality||"‚Äî"}<br>
            ${I18N[lang].add.resultsCountry}: ${country||"‚Äî"}<br>
            ${I18N[lang].add.resultsCoords}: (Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)})`;
          addLocationBtn.textContent = `${I18N[lang].add.addBtn.replace('"','')} \"${name}\"`;
          addLocationBtn.classList.remove('hidden');
        }else{ searchStatusP.textContent = I18N[lang].notif.outBbox; foundLocation=null; }
      }else{ searchStatusP.textContent = I18N[lang].notif.notFound; foundLocation=null; }
    }catch(e){ searchStatusP.textContent = I18N[lang].notif.errSearch; console.error(e); foundLocation=null; }
  }

  searchButton.addEventListener('click', doSearch);
  addLocationBtn.addEventListener('click', async ()=>{
    const lang=getLang();
    if (foundLocation){
      if (!LOCATIONS.find(l=>l.name===foundLocation.name)){
        const newLoc = { ...foundLocation, habitat: habitatSelect.value||undefined, ageClass: ageSelect.value||undefined, soilAcidity: soilSelect.value||undefined };
        LOCATIONS.push(newLoc); saveLocations();
        locationNameInput.value=''; habitatSelect.value=''; ageSelect.value=''; soilSelect.value=''; searchResultsDiv.classList.add('hidden');
        document.getElementById('loading-message').classList.remove('hidden');
        const result = await updateLocationData(newLoc);
        document.getElementById('loading-message').classList.add('hidden');
        if(result) refreshGrid();
      } else { searchStatusP.textContent = I18N[lang].notif.dup; }
    }
  });

  // ===== Controles filtro / orden
  function hookControls(){
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(btn=>btn.addEventListener('click', (e)=>{
      filterButtons.forEach(b=>b.classList.remove('bg-gray-400','text-white'));
      e.target.classList.add('bg-gray-400','text-white');
      currentFilter = e.target.dataset.filter;
      refreshGrid();
    }));
    const sortButtons = document.querySelectorAll('.sort-btn');
    sortButtons.forEach(btn=>btn.addEventListener('click', (e)=>{
      sortButtons.forEach(b=>b.classList.remove('bg-gray-400','text-white'));
      e.target.classList.add('bg-gray-400','text-white');
      currentSort = e.target.dataset.sort;
      refreshGrid();
    }));
  }

  // ===== Ayuda
  function fillHelpLists(){ const lang=getLang(); const ul = document.getElementById('help-list'); const us = document.getElementById('help-species'); ul.innerHTML = I18N[lang].help.list.map(s=>`<li>${s}</li>`).join(''); us.innerHTML = I18N[lang].help.speciesList.map(s=>`<li>${s}</li>`).join(''); }

  // ===== Idioma: aplicar a UI y redibujar tarjetas + luna
  function applyLanguage(){ applyStaticI18N(); fillSelectOptions(); fillHelpLists(); renderMoonPhase(); refreshGrid(); }

  // ===== Inicio
  document.addEventListener('DOMContentLoaded', async ()=>{
    setLang(getLang()); applyLanguage();
    const helpButton=document.getElementById('help-button'); const helpModal=document.getElementById('help-modal'); const closeButton=document.querySelector('.close');
    helpButton.onclick=()=> helpModal.style.display='block'; closeButton.onclick=()=> helpModal.style.display='none'; window.onclick=(e)=>{ if(e.target==helpModal) helpModal.style.display='none'; };
    fillSelectOptions(); hookControls(); await loadLocations();
  });

  // Toggle idioma
  window.__toggleLang = function(){ const next = (getLang()==='eu')?'es':'eu'; setLang(next); applyLanguage(); };
  document.getElementById('__langBtn').addEventListener('click', ()=> window.__toggleLang());

  // HOTFIX: desplegar/ocultar explicaci√≥n de la puntuaci√≥n (delegaci√≥n en #grid)
  (function(){ const grid = document.getElementById('grid'); if (!grid) return; grid.addEventListener('click', (ev)=>{ const btn = ev.target.closest('.toggle-score-btn'); if (!btn) return; const card = btn.closest('.card-item') || grid; const id = btn.dataset.targetId; const sel = '#' + (window.CSS && CSS.escape ? CSS.escape(id) : id); const details = card.querySelector(sel) || document.getElementById(id); if (details){ const hiddenNow = details.classList.toggle('hidden'); btn.setAttribute('aria-expanded', (!hiddenNow).toString()); } }); })();

  // MINI-PARCHE i18n para el desglose de puntuaci√≥n (ES‚ÜîEU) ‚Äî actualizado con VPD
  (function(){ if (window.__scoreI18N) return; window.__scoreI18N = true; const R = { es2eu: [ [/^Suelo h√∫medo \(SMI ‚â• 0\.7\)(.*)$/i,'Lurzoru hezea (SMI ‚â• 0.7)$1'], [/^Suelo con humedad media \(SMI ‚â• 0\.5\)(.*)$/i,'Lurzoru ertain-hezea (SMI ‚â• 0.5)$1'], [/^Suelo algo seco \(SMI > 0\.3\)(.*)$/i,'Lurzoru pixka bat lehorra (SMI > 0.3)$1'], [/^Suelo seco \(SMI ‚â§ 0\.3\)(.*)$/i,'Lurzoru lehorra (SMI ‚â§ 0.3)$1'], [/^Brote tras lluvia reciente \(\+([0-9.]+)\)$/i,'Euri berrien ondoko agerpena (+$1)'], [/^Reserva h√≠drica alta \(‚â•\s*80 mm\/20d\)(.*)$/i,'Ur erreserba handia (‚â•80 mm/20e)$1'], [/^Sequ√≠a prolongada \(<\s*40 mm\/30d\)(.*)$/i,'Lehorte luzea (<40 mm/30e)$1'], [/^Temp\. √≥ptima \(([0-9]+)[‚Äì-]([0-9]+)¬∞C\)(.*)$/i,'Tenperatura egokia ($1‚Äì$2¬∞C)$3'], [/^Calor alto \((>[0-9]+)¬∞C\)(.*)$/i,'Bero handia ($1¬∞C)$2'], [/^VPD bajo \(\+([0-9.]+)\)$/i,'VPD baxua (+$1)'], [/^VPD medio \(\+([0-9.]+)\)$/i,'VPD ertaina (+$1)'], [/^VPD alto \(([‚àí-]?[0-9.]+)\)$/i,'VPD handia ($1)'], [/^Viento\+calor \(([‚àí-][0-9.]+)\)$/i,'Haizea + beroa ($1)'], [/^Heladas recientes \(([‚àí-][0-9.]+)\)$/i,'Azken izozteak ($1)'], [/^Zona baja y temporada temprana \(([‚àí-][0-9.]+)\)$/i,'Behe-aldea eta sasoi goiztiarra ($1)'], [/^Alta monta√±a \(>1000 m, retraso temporada\) \(([‚àí-][0-9.]+)\)$/i,'Mendi garaia (>1000 m, sasoiaren atzerapena) ($1)'], [/^Factor de h√°bitat √ó([0-9.]+)$/i,'Habitat faktorea √ó$1'] ], eu2es: [ [/^Lurzoru hezea \(SMI ‚â• 0\.7\)(.*)$/i,'Suelo h√∫medo (SMI ‚â• 0.7)$1'], [/^Lurzoru ertain-hezea \(SMI ‚â• 0\.5\)(.*)$/i,'Suelo con humedad media (SMI ‚â• 0.5)$1'], [/^Lurzoru pixka bat lehorra \(SMI > 0\.3\)(.*)$/i,'Suelo algo seco (SMI > 0.3)$1'], [/^Lurzoru lehorra \(SMI ‚â§ 0\.3\)(.*)$/i,'Suelo seco (SMI ‚â§ 0.3)$1'], [/^Euri berrien ondoko agerpena \(\+([0-9.]+)\)$/i,'Brote tras lluvia reciente (+$1)'], [/^Ur erreserba handia \(‚â•80 mm\/20e\)(.*)$/i,'Reserva h√≠drica alta (‚â•80 mm/20d)$1'], [/^Lehorte luzea \(<40 mm\/30e\)(.*)$/i,'Sequ√≠a prolongada (<40 mm/30d)$1'], [/^Tenperatura egokia \(([0-9]+)[‚Äì-]([0-9]+)¬∞C\)(.*)$/i,'Temp. √≥ptima ($1‚Äì$2¬∞C)$3'], [/^Bero handia \((>[0-9]+)¬∞C\)(.*)$/i,'Calor alto ($1¬∞C)$2'], [/^VPD baxua \(\+([0-9.]+)\)$/i,'VPD bajo (+$1)'], [/^VPD ertaina \(\+([0-9.]+)\)$/i,'VPD medio (+$1)'], [/^VPD handia \(([‚àí-]?[0-9.]+)\)$/i,'VPD alto ($1)'], [/^Haizea \+ beroa \(([‚àí-][0-9.]+)\)$/i,'Viento+calor ($1)'], [/^Azken izozteak \(([‚àí-][0-9.]+)\)$/i,'Heladas recientes ($1)'], [/^Behe-aldea eta sasoi goiztiarra \(([‚àí-][0-9.]+)\)$/i,'Zona baja y temporada temprana ($1)'], [/^Mendi garaia \(>1000 m, sasoiaren atzerapena\) \(([‚àí-][0-9.]+)\)$/i,'Alta monta√±a (>1000 m, retraso temporada) ($1)'], [/^Habitat faktorea √ó([0-9.]+)$/i,'Factor de h√°bitat √ó$1'] ] }; function trLine(txt, toEU){ const pairs = toEU ? R.es2eu : R.eu2es; for(const [re,rep] of pairs){ if(re.test(txt)) return txt.replace(re,rep);} return txt; } function translateBreakdownsInDOM(){ const toEU = (localStorage.getItem('app_lang')==='eu'); document.querySelectorAll('#grid .score-breakdown li').forEach(li=>{ const t=(li.textContent||'').trim(); const nt=trLine(t,toEU); if(nt!==t) li.textContent=nt; }); document.querySelectorAll('#grid .score-breakdown-details p.font-bold').forEach(p=>{ const lang=localStorage.getItem('app_lang')||'es'; const label=(lang==='eu'?'Puntuazioa':'Puntuaci√≥n'); const span=p.querySelector('span'); p.textContent=label+': '; if(span) p.appendChild(span); }); } function hook(){ try{ translateBreakdownsInDOM(); }catch(_){} } if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', hook, {once:true}); } else { hook(); } const prevToggle = window.__toggleLang; window.__toggleLang = function(){ const r=(prevToggle?prevToggle.apply(this,arguments):null); hook(); return r; }; const prevRefresh = window.refreshGrid; window.refreshGrid = function(){ const r=prevRefresh.apply(this,arguments); hook(); return r; }; })();

</script>
</body>
</html>
